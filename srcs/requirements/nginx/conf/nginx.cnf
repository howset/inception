server {
	#port to listen (443) in ipv4 & 6
	listen	443 ssl;
	listen	[::]:443 ssl;

	#which domain to respond
	server_name ${DOMAIN_NAME};

	#SSL certs-key & TLS
	ssl_certificate_key			/etc/nginx/ssl/server.key;
	ssl_certificate				/etc/nginx/ssl/server.crt;
	ssl_protocols				TLSv1.3;
	ssl_ciphers					HIGH:!aNULL:!MD5; #whitelist secure methods & blacklist insecure ones
	ssl_prefer_server_ciphers	on; #prioritize this over client's

	#root directory & index file
	root	/var/www/html;
	index	index.html index.php;

	#try to serve exact file, if not found try as directory, if still not found then 404
#	location / {
#		try_files $uri $uri/ =404;
#	}

	#try to serve exact file, if not found try as directory, if still not found fallback to /index.php?$args
	location / {
		try_files	$uri $uri/ /index.php?$args;
	}

	# Directive for every request that finishes with .php
	location ~ \.php$ {
		# Check if php file exists; if not, error 404 not found
		try_files	$uri =404;
		# Pass the .php files to the FPM listening on this address
		fastcgi_pass	wordpress:${WP_PORT};
		 # Set the script name
		fastcgi_index	index.php;
		# Include the necessary variables
		include			fastcgi_params;
		fastcgi_param	SCRIPT_FILENAME $document_root$fastcgi_script_name;
	}

	# Include bonus service locations if they exist
	#include /etc/nginx/bonus.d/*.conf;
}

#redirect https://localhost to https://${DOMAIN_NAME}
server {
	listen	443 ssl;
	listen	[::]:443 ssl;

	#which domain to respond
	server_name localhost;

	ssl_certificate_key			/etc/nginx/ssl/server.key;
	ssl_certificate				/etc/nginx/ssl/server.crt;
	ssl_protocols				TLSv1.3;

	# Redirect all requests to domain
	return 301 https://${DOMAIN_NAME}$request_uri;
}

#redirect http://localhost to https://${DOMAIN_NAME} (because alpine opens 80 as default in /etc/nginx/http.d/default.conf)
server {
	listen 80;
	listen [::]:80;
	server_name ${DOMAIN_NAME} localhost;
	return 301 https://${DOMAIN_NAME}$request_uri;
}
