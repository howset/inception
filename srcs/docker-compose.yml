services:
  mariadb:
    image: mdb:inc42
    build:
      context: requirements/mariadb/
      dockerfile: Dockerfile
    container_name: mdb_cont
    volumes:
      - mdb_data:/var/lib/mysql
    environment:
      DB_NAME: ${DB_NAME}
      DB_USER_NAME: ${DB_USER_NAME}
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
    networks:
      - inception_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mariadb-admin", "ping", "-h", "localhost"]
      interval: 20s
      timeout: 5s
      retries: 3
    secrets:
      - db_user_pw

  wordpress:
    image: wp:inc42
    build:
      context: requirements/wordpress/
      dockerfile: Dockerfile
    container_name: wp_cont
    volumes:
      - wp_data:/var/www/html
    environment:
      DOMAIN_NAME: ${DOMAIN_NAME}
      DB_NAME: ${DB_NAME}
      DB_USER_NAME: ${DB_USER_NAME}
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      WP_TITLE: ${WP_TITLE}
      WP_MAD_USER: ${WP_MAD_USER}
      WP_MAD_EMAIL: ${WP_MAD_EMAIL}
      WP_PORT: ${WP_PORT}
      WP_USER: ${WP_USER}
      WP_USER_EMAIL: ${WP_USER_EMAIL}
    networks:
      - inception_network
    depends_on:
      mariadb:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "netstat -tnlp | grep :${WP_PORT} || exit 1"]
      #test: ["CMD-SHELL", "test -S /run/php-fpm.sock || exit 1"]
      #test: ["CMD-SHELL", "wp core is-installed --allow-root --path=/var/www/html > /dev/null 2>&1 || exit 1"]
      interval: 20s
      timeout: 5s
      retries: 3
    secrets:
      - db_user_pw
      - wp_mad_pw
      - wp_user_pw

  nginx:
    image: nginx:inc42
    build:
      context: requirements/nginx/
      dockerfile: Dockerfile
    container_name: nginx_cont
    volumes:
      - wp_data:/var/www/html
    environment:
      DOMAIN_NAME: ${DOMAIN_NAME}
      WP_PORT: ${WP_PORT}
    networks:
      - inception_network
    depends_on:
      wordpress:
        condition: service_healthy
      mariadb:
        condition: service_healthy
    restart: unless-stopped
    ports:
      #- "80:80"
      - "443:443"
    healthcheck:
      test: ["CMD", "curl", "-kfI", "https://localhost:443"]
      interval: 20s
      timeout: 5s
      retries: 3

volumes:
  mdb_data:
    name: mdb_vol
    driver: local
  wp_data:
    name: wp_vol
    driver: local

networks:
  inception_network:
    name: inception_network
    driver: bridge

secrets:
  db_user_pw:
    file: ${DB_USER_PW}
  wp_mad_pw:
    file: ${WP_MAD_PW}
  wp_user_pw:
    file: ${WP_USER_PW}